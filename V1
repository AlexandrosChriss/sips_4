#include <M5EPD.h>
#include <Wire.h>
#include "I2Cdev.h"
#include "MPU6050.h"

#define AXP192_ADDR 0x34

MPU6050 mpu;

// Fonction d’écriture dans le PMIC AXP192 (gestion de l’alim)
void writeAXP(uint8_t reg, uint8_t val) {
  Wire.beginTransmission(AXP192_ADDR);
  Wire.write(reg);
  Wire.write(val);
  Wire.endTransmission();
}

// Active le port A (5V pour l’I2C et périphériques)
void enable5VPortA() {
  Wire.begin();
  writeAXP(0x12, 0xFF); // Active toutes les sorties
  delay(100);
  Serial.println("Port A alimenté (5V activé via AXP192)");
}

void setup() {
  M5.begin();
  Serial.begin(115200);
  delay(500);

  Serial.println("=== Test M5Paper + MPU6050 ===");

  // Active le port A
  enable5VPortA();

  // Initialise le bus I2C sur le port A (SDA=25, SCL=32)
  Wire.begin(25, 32);
  Wire.setClock(400000);

  // Initialise le capteur MPU6050
  Serial.println("Initialisation du MPU6050...");
  mpu.initialize();

  if (mpu.testConnection()) {
    Serial.println("MPU6050 connecté avec succès !");
  } else {
    Serial.println("Erreur : connexion MPU6050 échouée !");
    while (1);
  }

  delay(1000);
}

void loop() {
  VectorInt16 accel; // Structure contenant X, Y, Z

  // Lecture des données d’accélération
  mpu.getAcceleration(&accel.x, &accel.y, &accel.z);

  // Affiche les valeurs sur le port série
  Serial.print("Accel X: ");
  Serial.print(accel.x);
  Serial.print("  Y: ");
  Serial.print(accel.y);
  Serial.print("  Z: ");
  Serial.println(accel.z);

  delay(500);
}
